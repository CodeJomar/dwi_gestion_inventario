<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiSupply S.A. - Ordenes</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" th:href="@{/styles/globals.css}">
    <link rel="stylesheet" th:href="@{/styles/ordenes.css}">
</head>

<body class="bg-background text-foreground">

<div id="inventory-system" class="min-h-screen">

    <header th:replace="~{fragments/header :: header}"></header>

    <main class="container mx-auto px-4 py-6 sm:px-6 lg:px-8">
        <div id="tabs-container" class="space-y-6">

            <nav th:replace="~{fragments/nav :: nav-ordenes}"></nav>

            <div id="tab-orders-content" data-tab-content="orders" class="tabs-content tabs-content-active space-y-6">
                <form th:action="@{/auth/ordenes}" method="GET" class="space-y-6">
                    <div id="orders-header-actions" class="flex flex-col sm:flex-row gap-4 justify-between">
                        <div class="flex flex-1 gap-4 flex-wrap">
                            <div class="relative flex-1 max-w-full sm:max-w-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                     stroke-linejoin="round"
                                     class="absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4">
                                    <circle cx="11" cy="11" r="8"/>
                                    <line x1="21" x2="16.65" y1="21" y2="16.65"/>
                                </svg>
                                <input id="search-orders" name="busqueda" type="text"
                                       placeholder="Buscar por ID, producto, email..."
                                       class="input pl-10" th:value="${busqueda}"/>
                            </div>
                            <button type="button" class="btn btn-outline text-sm w-full sm:w-auto"
                                    onclick="toggleOrderFilters()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                     stroke-linejoin="round" class="h-4 w-4 mr-2">
                                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                                </svg>
                                Filtros
                            </button>
                        </div>
                        <button type="button" class="btn btn-primary w-full sm:w-auto" onclick="abrirModalOrden()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                 fill="none"
                                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                 class="h-4 w-4 mr-2">
                                <path d="M12 5v14"/>
                                <path d="M5 12h14"/>
                            </svg>
                            Nueva Orden
                        </button>
                    </div>

                    <div id="order-filters-panel" class="card" style="display: none;">
                        <div class="card-content p-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-foreground">Filtros</h3>
                                <a th:href="@{/auth/ordenes}" class="text-sm text-primary hover:underline">Limpiar
                                    filtros</a>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-foreground mb-2">Tipo de Orden</label>
                                    <select id="filter-order-tipo" name="tipo" class="input w-full">
                                        <option value="">Todos</option>
                                        <option th:each="t : ${tiposOrden}"
                                                th:value="${t.name()}"
                                                th:text="${t.displayName}"
                                                th:selected="${t.name() == tipo}"></option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-foreground mb-2">Motivo</label>
                                    <select id="filter-order-motivo" name="motivo" class="input w-full">
                                        <option value="">Todos</option>
                                        <option th:each="m : ${motivosOrden}"
                                                th:value="${m.name()}"
                                                th:text="${m.displayName}"
                                                th:selected="${m.name() == motivo}"></option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-foreground mb-2">Fecha desde</label>
                                    <input type="date" id="filter-order-date-from" name="fechaDesde"
                                           class="input w-full"
                                           th:value="${fechaDesde}">
                                </div>
                                <div class="flex items-end">
                                    <button type="submit" class="btn btn-primary w-full">Aplicar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <div id="orders-list-container" class="space-y-4">
                    <div th:each="orden, iter : ${ordenes.content}" class="card hover:shadow-md transition-shadow">
                        <div class="card-content p-6">
                            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                                <div class="flex items-start space-x-4 flex-1 min-w-0">
                                    <div class="flex items-center justify-center w-12 h-12 bg-primary/10 rounded-lg flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                             stroke-linecap="round" stroke-linejoin="round"
                                             class="h-6 w-6 text-primary">
                                            <circle cx="8" cy="21" r="1"/>
                                            <circle cx="19" cy="21" r="1"/>
                                            <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.72a2 2 0 0 0 2-1.58L23 6H6"/>
                                        </svg>
                                    </div>
                                    <div class="min-w-0">
                                        <div class="flex flex-wrap items-center gap-2 md:gap-3 mb-1">
                                            <h3 class="font-semibold text-lg truncate text-foreground w-40"
                                                th:text="${orden.id}">ORD-001</h3>
                                            <span class="badge"
                                                  th:text="${orden.motivo.displayName}"
                                                  th:classappend="${orden.motivo.name() == 'VENTA' ? 'badge-destructive' : 'badge-outline'}">
                                                    Venta
                                            </span>
                                            <span class="text-sm font-medium"
                                                  th:text="${orden.tipo.displayName}"
                                                  th:classappend="${orden.tipo.name() == 'SALIDA' ? 'text-destructive' : 'text-primary'}">
                                                    Salida
                                            </span>
                                        </div>
                                        <p class="text-muted-foreground truncate"
                                           th:text="${orden.productoNombre} + ' (Por: ' + ${orden.creadoPor} + ')'">
                                            Producto (Por: usuario@mail.com)</p>
                                        <div class="flex items-center gap-4 mt-2 text-sm text-muted-foreground">
                                            <div class="flex items-center gap-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                     viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                     stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                     class="h-4 w-4">
                                                    <path d="M8 2v4"/>
                                                    <path d="M16 2v4"/>
                                                    <rect width="18" height="18" x="3" y="4" rx="2"/>
                                                    <path d="M3 10h18"/>
                                                </svg>
                                                <span th:text="${#temporals.format(orden.fechaCreacion, 'dd/MM/yyyy')}">15/10/2025</span>
                                            </div>
                                            <span th:text="${orden.cantidad} + ' unidades'">5 unidades</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right flex-shrink-0 w-full md:w-auto mt-4 md:mt-0">
                                    <p class="text-2xl font-bold text-primary mb-2"
                                       th:text="'S/ ' + ${#numbers.formatDecimal(orden.monto, 1, 'COMMA', 2, 'POINT')}">
                                        $2,340.00</p>
                                    <button type="button"
                                            class="btn btn-outline text-sm w-full md:w-auto btn-ver-detalle"
                                            th:data-id="${orden.id}"
                                            th:data-index="${iter.count}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                             stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-2">
                                            <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                        Ver Detalles
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="no-orders-found" class="card text-center py-12"
                     style="display: none;"
                     th:style="${ordenes.totalElements == 0} ? 'display: block;' : 'display: none;'">
                    <div class="card-content">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                             class="h-12 w-12 text-muted-foreground mx-auto mb-4">
                            <circle cx="8" cy="21" r="1"/>
                            <circle cx="19" cy="21" r="1"/>
                            <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.72a2 2 0 0 0 2-1.58L23 6H6"/>
                        </svg>
                        <h3 class="text-lg font-semibold mb-2 text-foreground">No se encontraron órdenes</h3>
                        <p class="text-muted-foreground mb-4"
                           th:text="${busqueda != null || tipo != null || motivo != null || fechaDesde != null} ? 'No hay órdenes que coincidan con tu búsqueda.' : 'No hay órdenes registradas aún.'"></p>
                        <button class="btn btn-primary" onclick="abrirModalOrden()">Crear Primera Orden</button>
                    </div>
                </div>

                <div class="flex items-center justify-between mt-6 border-t border-border pt-4"
                     th:if="${ordenes.totalElements > 0}">
                    <p class="text-sm text-muted-foreground">
                        Mostrando
                        <span class="font-medium text-foreground" th:text="${ordenes.size * ordenes.number + 1}"></span>
                        -
                        <span class="font-medium text-foreground"
                              th:text="${ordenes.size * ordenes.number + ordenes.numberOfElements}"></span>
                        de
                        <span class="font-medium text-foreground" th:text="${ordenes.totalElements}"></span>
                        registros
                    </p>
                    <div class="flex items-center gap-2" th:if="${ordenes.totalPages > 1}">
                        <a th:href="@{/auth/ordenes(page=${ordenes.number - 1}, busqueda=${busqueda}, tipo=${tipo}, motivo=${motivo}, fechaDesde=${fechaDesde})}"
                           th:classappend="${ordenes.first} ? 'pointer-events-none opacity-50' : ''"
                           class="btn btn-outline h-9 px-3 text-xs">
                            Anterior
                        </a>
                        <th:block th:each="i : ${#numbers.sequence(0, ordenes.totalPages - 1)}">
                            <a th:href="@{/auth/ordenes(page=${i}, busqueda=${busqueda}, tipo=${tipo}, motivo=${motivo}, fechaDesde=${fechaDesde})}"
                               th:text="${i + 1}"
                               class="btn h-9 w-9 p-0 flex items-center justify-center text-xs transition-colors"
                               th:classappend="${i == ordenes.number} ? 'btn-primary' : 'btn-outline hover:bg-accent'">
                            </a>
                        </th:block>
                        <a th:href="@{/auth/ordenes(page=${ordenes.number + 1}, busqueda=${busqueda}, tipo=${tipo}, motivo=${motivo}, fechaDesde=${fechaDesde})}"
                           th:classappend="${ordenes.last} ? 'pointer-events-none opacity-50' : ''"
                           class="btn btn-outline h-9 px-3 text-xs">
                            Siguiente
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div th:replace="~{content/ordenes/modal_nuevaOrden :: modal-nueva-orden}"></div>
<div th:replace="~{content/ordenes/modal_verOrden :: modal-ver-orden}"></div>
<script th:src="@{/scripts/main.js}"></script>
<script th:src="@{/scripts/ordenes.js}"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    // Este script maneja el modal de creación si hay un error de validación
    const abrirModal = /*[[${abrirModal}]]*/ false;
    if (abrirModal) {
        abrirModalOrden();
    }

    // Muestra alertas de éxito o error
    const exito = /*[[${exito}]]*/ null;
    if (exito) { Swal.fire({ icon: 'success', title: '¡Éxito!', text: exito, confirmButtonText: 'Aceptar' }); }

    const error = /*[[${error}]]*/ null;
    if (error) { Swal.fire({ icon: 'error', title: 'Error', text: error, confirmButtonText: 'Intentar de nuevo' }); }
    /*]]>*/
</script>
</body>
</html>